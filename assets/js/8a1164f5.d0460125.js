"use strict";(self.webpackChunkredstone_docs=self.webpackChunkredstone_docs||[]).push([[214],{3905:(e,t,a)=>{a.d(t,{Zo:()=>d,kt:()=>m});var n=a(7294);function r(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function o(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function i(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?o(Object(a),!0).forEach((function(t){r(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):o(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function s(e,t){if(null==e)return{};var a,n,r=function(e,t){if(null==e)return{};var a,n,r={},o=Object.keys(e);for(n=0;n<o.length;n++)a=o[n],t.indexOf(a)>=0||(r[a]=e[a]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)a=o[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var c=n.createContext({}),l=function(e){var t=n.useContext(c),a=t;return e&&(a="function"==typeof e?e(t):i(i({},t),e)),a},d=function(e){var t=l(e.components);return n.createElement(c.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},u=n.forwardRef((function(e,t){var a=e.components,r=e.mdxType,o=e.originalType,c=e.parentName,d=s(e,["components","mdxType","originalType","parentName"]),u=l(a),m=r,h=u["".concat(c,".").concat(m)]||u[m]||p[m]||o;return a?n.createElement(h,i(i({ref:t},d),{},{components:a})):n.createElement(h,i({ref:t},d))}));function m(e,t){var a=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=a.length,i=new Array(o);i[0]=u;var s={};for(var c in t)hasOwnProperty.call(t,c)&&(s[c]=t[c]);s.originalType=e,s.mdxType="string"==typeof e?e:r,i[1]=s;for(var l=2;l<o;l++)i[l]=a[l];return n.createElement.apply(null,i)}return n.createElement.apply(null,a)}u.displayName="MDXCreateElement"},6251:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>c,contentTitle:()=>i,default:()=>p,frontMatter:()=>o,metadata:()=>s,toc:()=>l});var n=a(7462),r=(a(7294),a(3905));const o={sidebar_position:1,sidebar_label:"\ud83d\udca1 How it works?"},i="\ud83d\udca1 How it works",s={unversionedId:"smart-contract-devs/how-it-works",id:"smart-contract-devs/how-it-works",title:"\ud83d\udca1 How it works",description:"Modular design",source:"@site/docs/smart-contract-devs/how-it-works.md",sourceDirName:"smart-contract-devs",slug:"/smart-contract-devs/how-it-works",permalink:"/docs/smart-contract-devs/how-it-works",draft:!1,editUrl:"https://github.com/redstone-finance/redstone-docs/tree/main/docs/smart-contract-devs/how-it-works.md",tags:[],version:"current",sidebarPosition:1,frontMatter:{sidebar_position:1,sidebar_label:"\ud83d\udca1 How it works?"},sidebar:"tutorialSidebar",previous:{title:"Smart Contract Devs",permalink:"/docs/category/smart-contract-devs"},next:{title:"\ud83d\ude80 Get started",permalink:"/docs/category/-get-started"}},c={},l=[{value:"Modular design",id:"modular-design",level:2},{value:"3 Ways to integrate",id:"3-ways-to-integrate",level:2},{value:"Data Flow",id:"data-flow",level:2},{value:"Data Format",id:"data-format",level:2},{value:"Data packing (off-chain data encoding)",id:"data-packing-off-chain-data-encoding",level:3},{value:"Data unpacking (on-chain data verification)",id:"data-unpacking-on-chain-data-verification",level:3},{value:"On-chain aggregation",id:"on-chain-aggregation",level:2},{value:"Types of values",id:"types-of-values",level:2},{value:"Security considerations",id:"security-considerations",level:2},{value:"Recommendations",id:"recommendations",level:2},{value:"Benchmarks",id:"benchmarks",level:2},{value:"Gas report for 1 unique signer:",id:"gas-report-for-1-unique-signer",level:3},{value:"Gas report for 10 unique signers:",id:"gas-report-for-10-unique-signers",level:3}],d={toc:l};function p(e){let{components:t,...a}=e;return(0,r.kt)("wrapper",(0,n.Z)({},d,a,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"-how-it-works"},"\ud83d\udca1 How it works"),(0,r.kt)("h2",{id:"modular-design"},"Modular design"),(0,r.kt)("p",null,"Putting data directly into storage is the easiest way to make information accessible to smart contracts. This approach used to work well for large update intervals and small number of assets. However, there are more and more tokens coming to DeFi and modern derivative protocols require much lower latency boosting the maintenance costs of the simple model."),(0,r.kt)("p",null,"That's why, RedStone proposes a completely new modular design where data is first put into a data availability layer and then fetched on-chain. This allow us to broadcast a large number of assets at high frequency to a cheaper layer and put it on chain only when required by the protocol."),(0,r.kt)("h2",{id:"3-ways-to-integrate"},"3 Ways to integrate"),(0,r.kt)("p",null,"Depending of the smart contract architecture and business demands we can deliver data using 3 different models:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("a",{parentName:"p",href:"/docs/smart-contract-devs/get-started/redstone-core"},"RedStone Core"),", data is dynamically injected to user transactions achieving maximum gas efficiency and maintaining a great user experience as the whole process fits into a single transaction")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("a",{parentName:"p",href:"/docs/smart-contract-devs/get-started/redstone-classic"},"RedStone Classic"),", data is pushed into on-chain storage via relayer. Dedicated to protocols designed for the traditional Oracles model, that want to have full control of the data source and update conditions.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("a",{parentName:"p",href:"/docs/smart-contract-devs/get-started/redstone-x"},"RedStone X"),", targetting the needs of the most advanced protocols such as perpetuals, options and derivatives by eliminating the front-running risk providing price feeds at the very next block after users' interactions"))),(0,r.kt)("h2",{id:"data-flow"},"Data Flow"),(0,r.kt)("a",{href:"https://raw.githubusercontent.com/redstone-finance/redstone-docs/main/static/img/architecture.png"},(0,r.kt)("img",{src:"/img/architecture.png",target:"_blank"})),(0,r.kt)("p",null,"The price feeds comes from multiiple sources such as off-chain DEX'ed (",(0,r.kt)("a",{parentName:"p",href:"https://binance.com"},"Binance"),", ",(0,r.kt)("a",{parentName:"p",href:"https://coinbase.com"},"Coinbase")," & ",(0,r.kt)("a",{parentName:"p",href:"https://kraken.com"},"Kraken"),", etc.), on-chain DEX'es (",(0,r.kt)("a",{parentName:"p",href:"https://uniswap.org/"},"Uniswap"),", ",(0,r.kt)("a",{parentName:"p",href:"https://www.sushi.com/"},"Sushiswap"),", ",(0,r.kt)("a",{parentName:"p",href:"https://balancer.fi/"},"Balancer"),", etc.) and aggregators (",(0,r.kt)("a",{parentName:"p",href:"https://coinmarketcap.com/"},"CoinmarketCap"),", ",(0,r.kt)("a",{parentName:"p",href:"https://www.coingecko.com/"},"Coingecko"),", ",(0,r.kt)("a",{parentName:"p",href:"https://www.kaiko.com/"},"Kaiko"),"). Currently, we've got more than ",(0,r.kt)("a",{parentName:"p",href:"https://app.redstone.finance/#/app/sources"},"50 sources integrated"),"."),(0,r.kt)("p",null,"The data is aggregated in independent nodes operated by data providers using various methodologies (eg. median, TWAP, LWAP) and safety measures like outliers detection. The cleaned and processed data is then signed by node operators underwriting the quality. "),(0,r.kt)("p",null,"The feeds are broadcasted both on the ",(0,r.kt)("a",{parentName:"p",href:"https://streamr.network/"},"StreamR")," and directly to open-source ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/redstone-finance/redstone-oracles-monorepo/tree/main/packages/cache-service"},"gateways")," which could be easily spun off on demand. "),(0,r.kt)("p",null,"The data could be pushed on-chain either by a dedicated relayer operating under predefined conditions (ie. heartbeat or price deviation), by a bot (ie. performing liquidations), or even by end users interacting with the protocol. "),(0,r.kt)("p",null,"Inside the protocol, the data is unpacked and verified cryptographically checking both the origin and timestamps."),(0,r.kt)("h2",{id:"data-format"},"Data Format"),(0,r.kt)("p",null,"At a top level, transferring data to an EVM environment requires packing an extra payload to a user's transaction and processing the message on-chain."),(0,r.kt)("a",{href:"https://raw.githubusercontent.com/redstone-finance/redstone-docs/main/static/img/redstone-tx-wrapping.png"},(0,r.kt)("img",{src:"/img/redstone-tx-wrapping.png",target:"_blank"})),(0,r.kt)("h3",{id:"data-packing-off-chain-data-encoding"},"Data packing (off-chain data encoding)"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Relevant data needs to be fetched from the decentralized cache layer, powered by the ",(0,r.kt)("a",{parentName:"li",href:"https://streamr.network/"},"streamr network")," and the RedStone light cache nodes"),(0,r.kt)("li",{parentName:"ol"},"Data is packed into a message according to the following structure")),(0,r.kt)("a",{href:"https://raw.githubusercontent.com/redstone-finance/redstone-docs/main/static/img/payload.png"},(0,r.kt)("img",{src:"/img/payload.png",target:"_blank"})),(0,r.kt)("ol",{start:3},(0,r.kt)("li",{parentName:"ol"},"The package is appended to the original transaction message, signed and submitted to the network")),(0,r.kt)("p",null,(0,r.kt)("em",{parentName:"p"},"All of the steps are executed automatically by the ContractWrapper and transparent to the end-user")),(0,r.kt)("h3",{id:"data-unpacking-on-chain-data-verification"},"Data unpacking (on-chain data verification)"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"The appended data packages are extracted from the ",(0,r.kt)("inlineCode",{parentName:"li"},"msg.data")),(0,r.kt)("li",{parentName:"ol"},"For each data package we:",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"Verify if the signature was created by trusted provider"),(0,r.kt)("li",{parentName:"ul"},"Validate the timestamp, checking if the information is not obsolete"))),(0,r.kt)("li",{parentName:"ol"},"Then, for each requested data feed we:",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"Calculate the number of received unique signers"),(0,r.kt)("li",{parentName:"ul"},"Extract value for each unique signer"),(0,r.kt)("li",{parentName:"ul"},"Calculate the aggregated value (median by default)")))),(0,r.kt)("p",null,(0,r.kt)("em",{parentName:"p"},"This logic is executed in the on-chain environment and we optimised the execution using a low-level assembly code to reduce gas consumption to the absolute minimum")),(0,r.kt)("h2",{id:"on-chain-aggregation"},"On-chain aggregation"),(0,r.kt)("p",null,"To increase the security of the RedStone oracle system, we've created the on-chain aggregation mechanism. This mechanism adds an additional requirement of passing at least X signatures from different authorised data providers for a given data feed. The values of different providers are then aggregated before returning to a consumer contract (by default, we use median value calculation for aggregation). This way, even if some small subset of providers corrupt (e.g. 2 of 10), it should not significantly affect the aggregated value."),(0,r.kt)("p",null,"There are the following on-chain aggregation params in RedStone consumer base contract:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"getUniqueSignersThreshold")," function"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"getAuthorisedSignerIndex")," function"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"aggregateValues")," function (for numeric values)"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"aggregateByteValues")," function (for bytes arrays)")),(0,r.kt)("h2",{id:"types-of-values"},"Types of values"),(0,r.kt)("p",null,"We support 2 types of data to be received in contract:"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Numeric 256-bit values (used by default)"),(0,r.kt)("li",{parentName:"ol"},"Bytes arrays with dynamic size")),(0,r.kt)("h2",{id:"security-considerations"},"Security considerations"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Do not override the ",(0,r.kt)("inlineCode",{parentName:"li"},"getUniqueSignersThreshold")," function, unless you are 100% sure about it"),(0,r.kt)("li",{parentName:"ul"},"Pay attention to the timestamp validation logic. For some use-cases (e.g. synthetic DEX), you would need to cache the latest values in your contract storage to avoid arbitrage attacks"),(0,r.kt)("li",{parentName:"ul"},"Enable secure upgradability mechanism for your contract (ideally based on multi-sig or DAO)"),(0,r.kt)("li",{parentName:"ul"},"Monitor the RedStone data services registry and quickly modify signer authorisation logic in your contracts in case of changes (we will also notify you if you are a paying client)")),(0,r.kt)("h2",{id:"recommendations"},"Recommendations"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Try to design your contracts in a way where you don't need to request many data feeds in the same transaction"),(0,r.kt)("li",{parentName:"ul"},"Use ~10 required unique signers for a good balance between security and gas cost efficiency")),(0,r.kt)("h2",{id:"benchmarks"},"Benchmarks"),(0,r.kt)("p",null,"You can check the benchmarks script and reports ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/redstone-finance/redstone-oracles-monorepo/tree/main/packages/evm-connector/benchmarks"},"here.")),(0,r.kt)("h3",{id:"gas-report-for-1-unique-signer"},"Gas report for 1 unique signer:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},'{\n  "1 data feed": {\n    "attaching to calldata": 1840,\n    "data extraction and validation": 10782\n  },\n  "2 data feeds": {\n    "attaching to calldata": 3380,\n    "data extraction and validation": 18657\n  },\n  "10 data feeds": {\n    "attaching to calldata": 15832,\n    "data extraction and validation": 95539\n  },\n}\n')),(0,r.kt)("h3",{id:"gas-report-for-10-unique-signers"},"Gas report for 10 unique signers:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},'{\n  "1 data feed": {\n    "attaching to calldata": 15796,\n    "data extraction and validation": 72828\n  },\n  "2 data feeds": {\n    "attaching to calldata": 31256,\n    "data extraction and validation": 146223\n  },\n  "10 data feeds": {\n    "attaching to calldata": 156148,\n    "data extraction and validation": 872336\n  },\n  "20 data feeds": {\n    "attaching to calldata": 313340,\n    "data extraction and validation": 2127313\n  }\n}\n')))}p.isMDXComponent=!0}}]);